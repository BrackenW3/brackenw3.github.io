name: Deploy to Cloudflare

on:
  push:
    branches:
      - main
    paths:
      - 'Cloudflare_Workers/**'
      - '*.html'
      - 'assets/**'
      - 'dashboard_files/**'
  workflow_dispatch:

jobs:
  deploy-worker:
    runs-on: ubuntu-latest
    name: Deploy Worker
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Check for Worker Changes
        uses: dorny/paths-filter@v2
        id: changes
        with:
          filters: |
            worker:
              - 'Cloudflare_Workers/**'

      - name: Deploy to Cloudflare Workers
        if: steps.changes.outputs.worker == 'true' || github.event_name == 'workflow_dispatch'
        uses: cloudflare/wrangler-action@v3
        with:
          apiToken: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          accountId: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          workingDirectory: 'Cloudflare_Workers'

  deploy-pages:
    runs-on: ubuntu-latest
    name: Deploy Pages
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Check for Frontend Changes
        uses: dorny/paths-filter@v2
        id: changes
        with:
          filters: |
            frontend:
              - '*.html'
              - 'assets/**'
              - 'dashboard_files/**'

      - name: Check Project Configuration
        id: check-config
        if: steps.changes.outputs.frontend == 'true' || github.event_name == 'workflow_dispatch'
        run: |
          if [ -z "${{ vars.CLOUDFLARE_PAGES_PROJECT_NAME }}" ]; then
            echo "configured=false" >> $GITHUB_OUTPUT
            echo "::warning::CLOUDFLARE_PAGES_PROJECT_NAME repository variable is not set. Please configure it in repository settings."
          else
            echo "configured=true" >> $GITHUB_OUTPUT
            echo "Project name: ${{ vars.CLOUDFLARE_PAGES_PROJECT_NAME }}"
          fi

      - name: Deploy to Cloudflare Pages
        if: (steps.changes.outputs.frontend == 'true' || github.event_name == 'workflow_dispatch') && steps.check-config.outputs.configured == 'true'
        uses: cloudflare/pages-action@v1
        with:
          apiToken: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          accountId: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          projectName: ${{ vars.CLOUDFLARE_PAGES_PROJECT_NAME }}
          directory: '.'
          gitHubToken: ${{ secrets.GITHUB_TOKEN }}

      - name: Configuration Help
        if: (steps.changes.outputs.frontend == 'true' || github.event_name == 'workflow_dispatch') && steps.check-config.outputs.configured == 'false'
        run: |
          echo "⚠️  Cloudflare Pages deployment skipped - project not configured"
          echo ""
          echo "To enable Cloudflare Pages deployment:"
          echo "1. Create a Cloudflare Pages project in your Cloudflare dashboard"
          echo "2. Go to: https://github.com/${{ github.repository }}/settings/variables/actions/new"
          echo "3. Create a repository variable named: CLOUDFLARE_PAGES_PROJECT_NAME"
          echo "4. Set its value to your Cloudflare Pages project name"
          echo ""
          echo "For more information, see the repository README.md"
